<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÎÇ¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§">
    <meta name="theme-color" content="#0A0A0F">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='22'/><text y='68' x='50' text-anchor='middle' font-size='52'>üíº</text></svg>">
    <title>ÎÇ¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</title>
    <style>
        :root {
            --bg: #0A0A0F;
            --surface: #12121C;
            --surface2: #1A1A28;
            --border: rgba(255,255,255,0.06);
            --text: #E8E8EC;
            --text2: #888;
            --text3: #555;
            --up: #FF4D4D;
            --up-bg: rgba(255,77,77,0.1);
            --down: #4D8CFF;
            --down-bg: rgba(77,140,255,0.1);
            --accent: #4D8CFF;
            --accent-bg: rgba(77,140,255,0.12);
            --green: #66BB6A;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overscroll-behavior: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            padding: calc(var(--safe-top) + 16px) 18px 16px;
            background: linear-gradient(180deg, #10102A 0%, var(--bg) 100%);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .header-title {
            font-size: 21px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header-sub {
            font-size: 11px;
            color: var(--text3);
            margin-top: 3px;
        }

        .header-sub .dot {
            display: inline-block;
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .refresh-btn {
            background: var(--accent-bg);
            border: 1px solid rgba(77,140,255,0.25);
            color: #8AB4FF;
            padding: 9px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .refresh-btn:active { transform: scale(0.95); }
        .refresh-btn.loading { opacity: 0.5; pointer-events: none; }

        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .summary-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .summary-card.wide { grid-column: 1 / -1; }
        .summary-label { font-size: 11px; color: var(--text3); margin-bottom: 2px; }
        .summary-val { font-size: 14px; font-weight: 700; color: #bbb; }
        .summary-big { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
        .summary-rate { font-size: 13px; font-weight: 600; margin-left: 6px; }
        .c-up { color: var(--up); }
        .c-down { color: var(--down); }
        .c-flat { color: var(--text2); }

        /* ‚îÄ‚îÄ View Toggle ‚îÄ‚îÄ */
        .view-toggle {
            display: flex;
            padding: 8px 18px;
            gap: 6px;
        }

        .view-btn {
            flex: 1;
            padding: 9px 0;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            color: var(--text2);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent-bg);
            border-color: rgba(77,140,255,0.35);
            color: #8AB4FF;
        }

        /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
        .content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(var(--safe-bottom) + 80px);
        }

        /* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 20px;
            text-align: center;
        }

        .empty-icon { font-size: 56px; margin-bottom: 12px; }
        .empty-title { font-size: 17px; font-weight: 700; color: var(--text2); }
        .empty-sub { font-size: 13px; color: var(--text3); margin-top: 6px; }

        /* ‚îÄ‚îÄ Stock Card ‚îÄ‚îÄ */
        .stock-list { padding: 6px 14px; }

        .card {
            background: rgba(255,255,255,0.025);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--text3);
            cursor: pointer;
            transition: all 0.15s;
        }

        .card:active { transform: scale(0.985); background: rgba(255,255,255,0.04); }
        .card.up-border { border-left-color: var(--up); }
        .card.down-border { border-left-color: var(--down); }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-name { font-size: 16px; font-weight: 700; margin-bottom: 3px; }

        .card-tags {
            display: flex; gap: 5px; align-items: center;
        }

        .card-code { font-size: 11px; color: var(--text3); }

        .card-sector {
            font-size: 10px;
            color: var(--text2);
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .card-price { font-size: 17px; font-weight: 700; text-align: right; }
        .card-change { font-size: 12px; font-weight: 600; text-align: right; margin-top: 2px; }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .mini-metric {
            background: rgba(255,255,255,0.025);
            padding: 7px 8px;
            border-radius: 6px;
        }

        .mini-label { font-size: 10px; color: var(--text3); margin-bottom: 2px; }
        .mini-val { font-size: 13px; font-weight: 600; }

        .bar-wrap { margin-bottom: 3px; }
        .bar-label { font-size: 10px; color: var(--text2); margin-bottom: 4px; }
        .bar-track {
            width: 100%; height: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
            overflow: hidden;
        }
        .bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }
        .bar-up { background: linear-gradient(90deg, var(--up), #FF8A80); }
        .bar-down { background: linear-gradient(90deg, var(--down), #82B1FF); }
        .bar-green { background: linear-gradient(90deg, var(--green), #A5D6A7); }

        .card-memo {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text2);
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .act-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .act-btn:active { transform: scale(0.96); }
        .act-edit { background: var(--accent-bg); border: 1px solid rgba(77,140,255,0.25); color: #8AB4FF; }
        .act-del { background: var(--up-bg); border: 1px solid rgba(255,77,77,0.25); color: #FF8A80; }

        /* ‚îÄ‚îÄ Treemap ‚îÄ‚îÄ */
        .map-wrap {
            margin: 8px 14px;
            flex: 1;
            min-height: 380px;
            background: rgba(255,255,255,0.02);
            border-radius: 14px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .map-legend {
            display: flex;
            gap: 10px;
            padding: 8px 12px;
            font-size: 11px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
        }

        .map-legend span { white-space: nowrap; }

        .map-svg { flex: 1; display: block; }

        /* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
        .fab {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 22px);
            right: 22px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4D8CFF, #2A5CCC);
            border: none;
            color: white;
            font-size: 30px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 24px rgba(77,140,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 30;
            transition: transform 0.15s;
        }

        .fab:active { transform: scale(0.9); }

        /* ‚îÄ‚îÄ Modal (Bottom Sheet) ‚îÄ‚îÄ */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-bg.open { display: flex; }

        .modal {
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 20px 18px calc(var(--safe-bottom) + 24px);
            width: 100%;
            max-width: 480px;
            max-height: 92vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.25s ease;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .modal-title { font-size: 19px; font-weight: 700; }

        .modal-close {
            background: rgba(255,77,77,0.12);
            border: none;
            color: #FF8A80;
            width: 32px; height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group { margin-bottom: 14px; }
        .form-label { font-size: 13px; font-weight: 600; color: #aaa; margin-bottom: 6px; }
        .form-label .req { color: var(--up); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            outline: none;
            -webkit-appearance: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
        }

        .form-textarea { min-height: 60px; resize: vertical; font-family: inherit; }

        .search-row { display: flex; gap: 8px; }

        .search-btn {
            padding: 0 16px;
            background: var(--accent-bg);
            border: 1px solid rgba(77,140,255,0.25);
            color: #8AB4FF;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .search-list {
            background: var(--bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 6px;
            max-height: 180px;
            overflow-y: auto;
        }

        .search-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .search-item:active { background: rgba(255,255,255,0.05); }
        .search-item-name { font-weight: 600; font-size: 14px; }
        .search-item-code { font-size: 12px; color: var(--text2); margin-top: 2px; }

        .selected-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-bg);
            border: 1px solid rgba(77,140,255,0.3);
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .chip-x {
            background: none; border: none;
            color: #FF8A80; font-size: 18px;
            cursor: pointer; padding: 0 4px;
        }

        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }

        .btn-cancel, .btn-save {
            flex: 1;
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-cancel { background: rgba(255,255,255,0.06); color: #aaa; }
        .btn-save {
            background: linear-gradient(135deg, #4D8CFF, #2A5CCC);
            color: white;
        }
        .btn-save:disabled { opacity: 0.35; }
        .btn-cancel:active, .btn-save:active { transform: scale(0.97); }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 90px);
            left: 50%; transform: translateX(-50%);
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show { opacity: 1; }

        /* ‚îÄ‚îÄ Share ‚îÄ‚îÄ */
        .share-btn {
            background: rgba(102,187,106,0.12);
            border: 1px solid rgba(102,187,106,0.25);
            color: #A5D6A7;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .share-btn:active { transform: scale(0.95); }

        .import-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            align-items: center; justify-content: center;
            padding: 24px;
        }
        .import-overlay.open { display: flex; }
        .import-box {
            background: var(--surface);
            border-radius: 16px;
            padding: 28px 20px;
            width: 100%; max-width: 360px;
            text-align: center;
            animation: fadeIn 0.2s ease;
        }
        .import-icon { font-size: 48px; margin-bottom: 12px; }
        .import-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .import-desc { font-size: 13px; color: var(--text2); margin-bottom: 6px; line-height: 1.5; }
        .import-count { font-size: 15px; font-weight: 700; color: var(--accent); margin-bottom: 18px; }
        .import-btns { display: flex; gap: 10px; }
        .import-btns button {
            flex: 1; padding: 14px 0; border: none;
            border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer;
        }
        .import-skip { background: rgba(255,255,255,0.06); color: #aaa; }
        .import-replace { background: linear-gradient(135deg, #4D8CFF, #2A5CCC); color: white; }

        /* ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ */
        .detail-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 90;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .detail-bg.open { display: flex; }

        .detail-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px 20px;
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="app" id="app"></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
        let state = {
            stocks: [],
            view: 'list',
            refreshing: false,
            lastUpdate: null,
            expandedIdx: null,
            showModal: false,
            editIdx: -1,
            selectedStock: null,
            searchQuery: '',
            searchResults: [],
            searching: false,
            form: { quantity: '', buyPrice: '', targetPrice: '', sector: '', memo: '' }
        };

        const SECTORS = [
            { v: 'IT', l: 'IT/Í∏∞Ïà†' }, { v: 'Í∏àÏúµ', l: 'Í∏àÏúµ' },
            { v: 'Ï†úÏ°∞', l: 'Ï†úÏ°∞/ÏûêÎèôÏ∞®' }, { v: 'Î∞îÏù¥Ïò§', l: 'Î∞îÏù¥Ïò§/Ìó¨Ïä§ÏºÄÏñ¥' },
            { v: 'ÏóêÎÑàÏßÄ', l: 'ÏóêÎÑàÏßÄ/ÌôîÌïô' }, { v: 'ÌÜµÏã†', l: 'ÌÜµÏã†' },
            { v: 'Î∞©ÏÇ∞', l: 'Î∞©ÏÇ∞/Ìï≠Í≥µ' }, { v: 'ETF', l: 'ETF' }, { v: 'Í∏∞ÌÉÄ', l: 'Í∏∞ÌÉÄ' }
        ];

        // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
        const fmt = n => Number(n || 0).toLocaleString('ko-KR');
        const parseP = s => parseInt(String(s).replace(/,/g, ''), 10) || 0;

        function getTreeColor(rate) {
            if (rate > 0) { const i = Math.min(rate/8,1); return `hsl(4,78%,${72-i*38}%)`; }
            if (rate < 0) { const i = Math.min(Math.abs(rate)/8,1); return `hsl(215,78%,${72-i*38}%)`; }
            return '#555';
        }

        // ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ
        function saveStocks() {
            try { localStorage.setItem('pf_stocks', JSON.stringify(state.stocks)); } catch(e) {}
        }

        function loadStocks() {
            try {
                const d = localStorage.getItem('pf_stocks');
                if (d) state.stocks = JSON.parse(d);
            } catch(e) {}
        }

        // ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ
        async function searchStockAPI(query) {
            try {
                const r = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                return await r.json();
            } catch(e) { return []; }
        }

        async function fetchPrice(code) {
            try {
                const r = await fetch(`/api/stock/${code}`);
                const d = await r.json();
                console.log(`[fetchPrice] ${code}:`, d);
                return d.success ? d : null;
            } catch(e) { console.error(`[fetchPrice] ${code} error:`, e); return null; }
        }

        async function fetchBatch(codes) {
            try {
                console.log('[fetchBatch] requesting:', codes);
                const r = await fetch('/api/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codes })
                });
                if (!r.ok) {
                    console.error('[fetchBatch] HTTP error:', r.status, r.statusText);
                    showToast(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${r.status}`);
                    return [];
                }
                const d = await r.json();
                console.log('[fetchBatch] response:', d);
                return d.success ? d.results : [];
            } catch(e) {
                console.error('[fetchBatch] error:', e);
                showToast('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®');
                return [];
            }
        }

        // ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ
        async function doSearch() {
            const q = state.searchQuery.trim();
            if (!q) return;
            state.searching = true;
            render();
            state.searchResults = await searchStockAPI(q);
            state.searching = false;
            render();
        }

        function selectSearchResult(item) {
            state.selectedStock = item;
            state.searchResults = [];
            state.searchQuery = '';
            render();
        }

        async function refreshAll() {
            if (!state.stocks.length || state.refreshing) return;
            state.refreshing = true;
            render();
            showToast('ÏãúÏÑ∏ Ï°∞Ìöå Ï§ë...');

            const codes = state.stocks.map(s => s.code);
            let results = await fetchBatch(codes);

            // batch Ïã§Ìå® Ïãú Í∞úÎ≥Ñ Ï°∞ÌöåÎ°ú Ìè¥Î∞±
            if (!results.length && codes.length) {
                console.log('[refreshAll] batch failed, trying individual fetch...');
                showToast('Í∞úÎ≥Ñ Ï°∞Ìöå Ï§ë...');
                results = [];
                for (const code of codes) {
                    const r = await fetchPrice(code);
                    if (r) results.push(r);
                }
            }

            let updated = 0;
            results.forEach(r => {
                // ÎåÄÏÜåÎ¨∏Ïûê Î¨¥ÏãúÌïòÍ≥† Îß§Ïπ≠
                const rCode = (r.code || '').toUpperCase();
                const idx = state.stocks.findIndex(s => s.code.toUpperCase() === rCode);
                if (idx !== -1) {
                    state.stocks[idx].price = r.price;
                    state.stocks[idx].change = r.change;
                    state.stocks[idx].changeRate = r.changeRate;
                    state.stocks[idx].lastUpdated = new Date().toISOString();
                    updated++;
                }
            });

            saveStocks();
            state.refreshing = false;
            state.lastUpdate = new Date();
            render();

            if (updated > 0) {
                showToast(`${updated}Í∞ú Ï¢ÖÎ™© ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`);
            } else {
                showToast('ÏãúÏÑ∏ Ï°∞Ìöå Ïã§Ìå® - ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî');
            }
        }

        async function saveStock() {
            const f = state.form;
            const sel = state.selectedStock;
            if (!sel || !f.quantity || !f.buyPrice || !f.sector) return;

            if (state.editIdx === -1 && state.stocks.find(s => s.code === sel.code)) {
                showToast('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú Ï¢ÖÎ™©ÏûÖÎãàÎã§');
                return;
            }

            showToast('ÏãúÏÑ∏ Ï°∞Ìöå Ï§ë...');
            const price = await fetchPrice(sel.code);

            const stock = {
                name: sel.name,
                code: sel.code,
                price: price ? price.price : 0,
                change: price ? price.change : 0,
                changeRate: price ? price.changeRate : 0,
                quantity: parseFloat(f.quantity),
                buyPrice: parseInt(f.buyPrice),
                targetPrice: f.targetPrice ? parseInt(f.targetPrice) : 0,
                sector: f.sector,
                memo: f.memo,
                addedAt: state.editIdx !== -1 ? state.stocks[state.editIdx].addedAt : new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };

            if (state.editIdx !== -1) {
                state.stocks[state.editIdx] = stock;
            } else {
                state.stocks.push(stock);
            }

            saveStocks();
            closeModal();
            state.lastUpdate = new Date();
            render();
            showToast(state.editIdx !== -1 ? 'ÏàòÏ†ï ÏôÑÎ£å' : 'Ï¢ÖÎ™© Ï∂îÍ∞Ä ÏôÑÎ£å');
        }

        function deleteStock(idx) {
            if (confirm(`${state.stocks[idx].name}ÏùÑ(Î•º) ÏÇ≠Ï†úÌï†ÍπåÏöî?`)) {
                state.stocks.splice(idx, 1);
                saveStocks();
                state.expandedIdx = null;
                render();
                showToast('ÏÇ≠Ï†ú ÏôÑÎ£å');
            }
        }

        function openAdd() {
            state.showModal = true;
            state.editIdx = -1;
            state.selectedStock = null;
            state.searchQuery = '';
            state.searchResults = [];
            state.form = { quantity: '', buyPrice: '', targetPrice: '', sector: '', memo: '' };
            render();
            setTimeout(() => document.getElementById('searchInput')?.focus(), 300);
        }

        function openEdit(idx) {
            const s = state.stocks[idx];
            state.showModal = true;
            state.editIdx = idx;
            state.selectedStock = { name: s.name, code: s.code };
            state.searchQuery = '';
            state.searchResults = [];
            state.form = {
                quantity: String(s.quantity),
                buyPrice: String(s.buyPrice),
                targetPrice: s.targetPrice ? String(s.targetPrice) : '',
                sector: s.sector,
                memo: s.memo || ''
            };
            render();
        }

        function closeModal() {
            state.showModal = false;
            state.editIdx = -1;
            state.selectedStock = null;
            state.searchQuery = '';
            state.searchResults = [];
            render();
        }

        let toastTimer;
        function showToast(msg) {
            const t = document.getElementById('toast');
            if (t) { t.textContent = msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 2000); }
        }

        // ‚îÄ‚îÄ‚îÄ Treemap ‚îÄ‚îÄ‚îÄ
        function squarify(items, x, y, w, h) {
            if (!items.length) return [];
            if (items.length === 1) return [{ ...items[0], x, y, w, h }];
            if (items.length <= 3) {
                const total = items.reduce((s,i) => s + Math.max(i.val,1), 0);
                let off = 0;
                return items.map(item => {
                    const ratio = Math.max(item.val,1)/Math.max(total,1);
                    let r;
                    if (h >= w) { const rh = h*ratio; r = { ...item, x, y: y+off, w, h: rh }; off += rh; }
                    else { const rw = w*ratio; r = { ...item, x: x+off, y, w: rw, h }; off += rw; }
                    return r;
                });
            }
            const mid = Math.ceil(items.length/2);
            const left = items.slice(0,mid), right = items.slice(mid);
            const tl = left.reduce((s,i) => s+Math.max(i.val,1),0);
            const ta = items.reduce((s,i) => s+Math.max(i.val,1),0);
            const ratio = tl/Math.max(ta,1);
            if (w >= h) { const sw = w*ratio; return [...squarify(left,x,y,sw,h),...squarify(right,x+sw,y,w-sw,h)]; }
            else { const sh = h*ratio; return [...squarify(left,x,y,w,sh),...squarify(right,x,y+sh,w,h-sh)]; }
        }

        // ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ
        function render() {
            const totalInvest = state.stocks.reduce((s,st) => s + st.buyPrice * st.quantity, 0);
            const totalValue = state.stocks.reduce((s,st) => s + parseP(st.price) * st.quantity, 0);
            const totalProfit = totalValue - totalInvest;
            const totalRate = totalInvest > 0 ? (totalProfit/totalInvest*100) : 0;
            const profitClass = totalProfit >= 0 ? 'c-up' : totalProfit < 0 ? 'c-down' : 'c-flat';

            const updateStr = state.lastUpdate
                ? state.lastUpdate.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' })
                : '';

            let html = `
                <div class="header">
                    <div class="header-top">
                        <div>
                            <div class="header-title">üíº ÎÇ¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</div>
                            ${updateStr ? `<div class="header-sub"><span class="dot"></span>${updateStr} ÏóÖÎç∞Ïù¥Ìä∏</div>` : ''}
                        </div>
                        <div style="display:flex;gap:6px">
                            ${state.stocks.length ? `<button class="share-btn" onclick="encodePortfolio()">üì§ Í≥µÏú†</button>` : ''}
                            <button class="refresh-btn ${state.refreshing?'loading':''}" onclick="refreshAll()">
                            ${state.refreshing ? '‚è≥ Ï°∞ÌöåÏ§ë' : 'üîÑ ÏãúÏÑ∏Í∞±Ïã†'}
                        </button>
                        </div>
                    </div>
                    ${state.stocks.length ? `
                    <div class="summary">
                        <div class="summary-card">
                            <div class="summary-label">Ìà¨ÏûêÍ∏à</div>
                            <div class="summary-val">${fmt(totalInvest)}Ïõê</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">ÌèâÍ∞ÄÏï°</div>
                            <div class="summary-val">${fmt(totalValue)}Ïõê</div>
                        </div>
                        <div class="summary-card wide">
                            <div class="summary-label">Ï¥ù ÏÜêÏùµ</div>
                            <div class="summary-big ${profitClass}">
                                ${totalProfit>=0?'+':''}${fmt(totalProfit)}Ïõê
                                <span class="summary-rate">(${totalRate>=0?'+':''}${totalRate.toFixed(2)}%)</span>
                            </div>
                        </div>
                    </div>` : ''}
                </div>
            `;

            // View toggle
            if (state.stocks.length) {
                html += `
                <div class="view-toggle">
                    <button class="view-btn ${state.view==='list'?'active':''}" onclick="state.view='list';render()">üìã Î™©Î°ù</button>
                    <button class="view-btn ${state.view==='map'?'active':''}" onclick="state.view='map';render()">üó∫Ô∏è Îßµ</button>
                </div>`;
            }

            html += '<div class="content">';

            if (!state.stocks.length) {
                html += `
                <div class="empty">
                    <div class="empty-icon">üìä</div>
                    <div class="empty-title">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§</div>
                    <div class="empty-sub">ÏïÑÎûò + Î≤ÑÌäºÏúºÎ°ú Ï¢ÖÎ™©ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>
                </div>`;
            } else if (state.view === 'list') {
                html += '<div class="stock-list">';
                state.stocks.forEach((s, i) => {
                    const cur = parseP(s.price);
                    const invest = s.buyPrice * s.quantity;
                    const val = cur * s.quantity;
                    const profit = val - invest;
                    const rate = invest > 0 ? (profit/invest*100) : 0;
                    const isUp = profit >= 0;
                    const expanded = state.expandedIdx === i;
                    const chgColor = s.changeRate > 0 ? 'c-up' : s.changeRate < 0 ? 'c-down' : 'c-flat';
                    const arrow = s.change >= 0 ? '‚ñ≤' : '‚ñº';
                    const tProg = s.targetPrice ? Math.min(100, cur/s.targetPrice*100) : 0;

                    html += `
                    <div class="card ${isUp?'up-border':'down-border'}" onclick="state.expandedIdx=${expanded?'null':i};render()">
                        <div class="card-top">
                            <div>
                                <div class="card-name">${s.name}</div>
                                <div class="card-tags">
                                    <span class="card-code">${s.code}</span>
                                    <span class="card-sector">${s.sector}</span>
                                </div>
                            </div>
                            <div>
                                <div class="card-price">${fmt(cur)}Ïõê</div>
                                <div class="card-change ${chgColor}">
                                    ${arrow} ${fmt(Math.abs(s.change))} (${s.changeRate>=0?'+':''}${s.changeRate}%)
                                </div>
                            </div>
                        </div>

                        <div class="card-grid">
                            <div class="mini-metric"><div class="mini-label">Î≥¥Ïú†</div><div class="mini-val">${s.quantity}Ï£º</div></div>
                            <div class="mini-metric"><div class="mini-label">Îß§ÏàòÍ∞Ä</div><div class="mini-val">${fmt(s.buyPrice)}Ïõê</div></div>
                            <div class="mini-metric"><div class="mini-label">ÌèâÍ∞ÄÏï°</div><div class="mini-val">${fmt(val)}Ïõê</div></div>
                            <div class="mini-metric"><div class="mini-label">ÏÜêÏùµ</div><div class="mini-val ${isUp?'c-up':'c-down'}">${profit>=0?'+':''}${fmt(profit)}Ïõê</div></div>
                        </div>

                        <div class="bar-wrap">
                            <div class="bar-label">ÏàòÏùµÎ•†: ${rate>=0?'+':''}${rate.toFixed(2)}%</div>
                            <div class="bar-track"><div class="bar-fill ${isUp?'bar-up':'bar-down'}" style="width:${Math.min(Math.abs(rate),100)}%"></div></div>
                        </div>

                        ${s.targetPrice ? `
                        <div class="bar-wrap" style="margin-top:6px">
                            <div class="bar-label">Î™©ÌëúÍ∞Ä: ${fmt(s.targetPrice)}Ïõê (${tProg.toFixed(1)}%)</div>
                            <div class="bar-track"><div class="bar-fill bar-green" style="width:${tProg}%"></div></div>
                        </div>` : ''}

                        ${s.memo ? `<div class="card-memo">üìù ${s.memo}</div>` : ''}

                        ${expanded ? `
                        <div class="card-actions">
                            <button class="act-btn act-edit" onclick="event.stopPropagation();openEdit(${i})">‚úèÔ∏è ÏàòÏ†ï</button>
                            <button class="act-btn act-del" onclick="event.stopPropagation();deleteStock(${i})">üóëÔ∏è ÏÇ≠Ï†ú</button>
                        </div>` : ''}
                    </div>`;
                });
                html += '</div>';
            } else {
                // Treemap
                html += `<div class="map-wrap" id="mapWrap">
                    <div class="map-legend">
                        <span style="color:#FF6B6B">‚ñ† ÏÉÅÏäπ</span>
                        <span style="color:#888">‚ñ† Î≥¥Ìï©</span>
                        <span style="color:#6B9FFF">‚ñ† ÌïòÎùΩ</span>
                        <span style="font-size:10px;color:#666">Î©¥Ï†Å=ÌèâÍ∞ÄÏï° / ÏÉâ=ÎãπÏùºÎì±ÎùΩ</span>
                    </div>
                    <svg class="map-svg" id="mapSvg"></svg>
                </div>`;
            }

            html += '</div>';

            // FAB
            html += '<button class="fab" onclick="openAdd()">Ôºã</button>';

            // Modal
            if (state.showModal) {
                const sel = state.selectedStock;
                const f = state.form;
                const canSave = sel && f.quantity && f.buyPrice && f.sector;

                html += `
                <div class="modal-bg open" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-head">
                            <div class="modal-title">${state.editIdx!==-1 ? '‚úèÔ∏è Ï¢ÖÎ™© ÏàòÏ†ï' : '‚≠ê Ï¢ÖÎ™© Ï∂îÍ∞Ä'}</div>
                            <button class="modal-close" onclick="closeModal()">‚úï</button>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Ï¢ÖÎ™© Í≤ÄÏÉâ <span class="req">*</span></div>
                            ${sel ? `
                                <div class="selected-chip">
                                    <span>${sel.name} (${sel.code})</span>
                                    <button class="chip-x" onclick="state.selectedStock=null;render()">‚úï</button>
                                </div>
                            ` : `
                                <div class="search-row">
                                    <input id="searchInput" class="form-input" placeholder="Ï¢ÖÎ™©Î™Ö (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê)" 
                                           value="${state.searchQuery}" 
                                           oninput="state.searchQuery=this.value"
                                           onkeydown="if(event.key==='Enter')doSearch()">
                                    <button class="search-btn" onclick="doSearch()" ${state.searching?'disabled':''}>
                                        ${state.searching ? '‚è≥' : 'üîç'}
                                    </button>
                                </div>
                                ${state.searchResults.length ? `
                                <div class="search-list">
                                    ${state.searchResults.map((r,i) => `
                                        <div class="search-item" onclick="selectSearchResult({name:'${r.name.replace(/'/g,"\\'")}',code:'${r.code}'})">
                                            <div class="search-item-name">${r.name}</div>
                                            <div class="search-item-code">${r.code}</div>
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                            `}
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <div class="form-label">Î≥¥Ïú† ÏàòÎüâ <span class="req">*</span></div>
                                <input class="form-input" type="number" placeholder="10" value="${f.quantity}"
                                       oninput="state.form.quantity=this.value">
                            </div>
                            <div class="form-group">
                                <div class="form-label">ÌèâÍ∑† Îß§ÏàòÍ∞Ä <span class="req">*</span></div>
                                <input class="form-input" type="number" placeholder="70000" value="${f.buyPrice}"
                                       oninput="state.form.buyPrice=this.value">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <div class="form-label">Î™©ÌëúÍ∞Ä</div>
                                <input class="form-input" type="number" placeholder="100000" value="${f.targetPrice}"
                                       oninput="state.form.targetPrice=this.value">
                            </div>
                            <div class="form-group">
                                <div class="form-label">ÏÑπÌÑ∞ <span class="req">*</span></div>
                                <select class="form-select" onchange="state.form.sector=this.value">
                                    <option value="">ÏÑ†ÌÉù...</option>
                                    ${SECTORS.map(s => `<option value="${s.v}" ${f.sector===s.v?'selected':''}>${s.l}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="form-label">Î©îÎ™®</div>
                            <textarea class="form-textarea" placeholder="Ìà¨Ïûê Î©îÎ™®..."
                                      oninput="state.form.memo=this.value">${f.memo}</textarea>
                        </div>

                        <div class="modal-btns">
                            <button class="btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                            <button class="btn-save" onclick="saveStock()" ${canSave?'':'disabled'}>
                                ${state.editIdx!==-1 ? 'ÏàòÏ†ï ÏôÑÎ£å' : 'Ï∂îÍ∞Ä'}
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            html += '<div class="toast" id="toast"></div>';

            // Import overlay
            if (state.showImport && state.importData) {
                const cnt = state.importData.length;
                const names = state.importData.slice(0, 3).map(s => s.name).join(', ');
                const more = cnt > 3 ? ` Ïô∏ ${cnt - 3}Ï¢ÖÎ™©` : '';
                html += `
                <div class="import-overlay open" onclick="cancelImport()">
                    <div class="import-box" onclick="event.stopPropagation()">
                        <div class="import-icon">üì•</div>
                        <div class="import-title">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í∞ÄÏ†∏Ïò§Í∏∞</div>
                        <div class="import-desc">Í≥µÏú† ÎßÅÌÅ¨ÏóêÏÑú Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Î•º Î∞úÍ≤¨ÌñàÏäµÎãàÎã§</div>
                        <div class="import-count">${names}${more} (${cnt}Ï¢ÖÎ™©)</div>
                        <div class="import-btns">
                            <button class="import-skip" onclick="cancelImport()">Ï∑®ÏÜå</button>
                            <button class="import-replace" onclick="doImport('replace')">Í∞ÄÏ†∏Ïò§Í∏∞</button>
                        </div>
                    </div>
                </div>`;
            }

            document.getElementById('app').innerHTML = html;

            // Render treemap SVG after DOM update
            if (state.view === 'map' && state.stocks.length) {
                requestAnimationFrame(renderTreemap);
            }
        }

        function renderTreemap() {
            const wrap = document.getElementById('mapWrap');
            const svg = document.getElementById('mapSvg');
            if (!wrap || !svg) return;

            const w = wrap.clientWidth;
            const h = wrap.clientHeight - 36; // minus legend
            svg.setAttribute('width', w);
            svg.setAttribute('height', h);

            const items = state.stocks
                .map((s,i) => ({ id: i, name: s.name, val: parseP(s.price)*s.quantity, changeRate: s.changeRate||0 }))
                .sort((a,b) => b.val - a.val);

            const rects = squarify(items, 0, 0, w, h);
            let svgHTML = '';

            rects.forEach(r => {
                const fs = Math.max(9, Math.min(r.w/5, r.h/3.5, 15));
                const name = r.name.length > 6 && r.w < 75 ? r.name.slice(0,5)+'..' : r.name;
                svgHTML += `<rect x="${r.x+1}" y="${r.y+1}" width="${Math.max(0,r.w-2)}" height="${Math.max(0,r.h-2)}" rx="5" fill="${getTreeColor(r.changeRate)}" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>`;
                if (r.w > 38 && r.h > 22) {
                    svgHTML += `<text x="${r.x+r.w/2}" y="${r.y+r.h/2-(r.h>38?fs*0.4:0)}" text-anchor="middle" dominant-baseline="middle" fill="white" font-weight="700" font-size="${fs}" style="text-shadow:0 1px 3px rgba(0,0,0,0.6);pointer-events:none">${name}</text>`;
                }
                if (r.w > 38 && r.h > 38) {
                    svgHTML += `<text x="${r.x+r.w/2}" y="${r.y+r.h/2+fs*0.7}" text-anchor="middle" dominant-baseline="middle" fill="white" font-weight="600" font-size="${Math.max(8,fs*0.8)}" style="text-shadow:0 1px 3px rgba(0,0,0,0.6);pointer-events:none">${r.changeRate>=0?'+':''}${r.changeRate}%</text>`;
                }
            });

            svg.innerHTML = svgHTML;
        }

        // ‚îÄ‚îÄ‚îÄ Share / Import ‚îÄ‚îÄ‚îÄ
        function encodePortfolio() {
            if (!state.stocks.length) { showToast('Í≥µÏú†Ìï† Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§'); return; }
            // ÏµúÏÜå Îç∞Ïù¥ÌÑ∞Îßå Ï∂îÏ∂ú (URL Í∏∏Ïù¥ Ï†àÏïΩ)
            const min = state.stocks.map(s => ({
                n: s.name, c: s.code, q: s.quantity,
                b: s.buyPrice, t: s.targetPrice || 0,
                s: s.sector, m: s.memo || ''
            }));
            const json = JSON.stringify(min);
            const encoded = btoa(unescape(encodeURIComponent(json)));
            const url = location.origin + location.pathname + '?pf=' + encoded;

            if (navigator.share) {
                navigator.share({
                    title: 'ÎÇ¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§',
                    text: `Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ${state.stocks.length}Ï¢ÖÎ™©`,
                    url: url
                }).catch(() => {});
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Í≥µÏú† ÎßÅÌÅ¨ Î≥µÏÇ¨ ÏôÑÎ£å!');
                }).catch(() => {
                    prompt('ÏïÑÎûò ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌïòÏÑ∏Ïöî:', url);
                });
            } else {
                prompt('ÏïÑÎûò ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌïòÏÑ∏Ïöî:', url);
            }
        }

        function checkImportUrl() {
            const params = new URLSearchParams(location.search);
            const pf = params.get('pf');
            if (!pf) return;

            try {
                const json = decodeURIComponent(escape(atob(pf)));
                const items = JSON.parse(json);
                if (!Array.isArray(items) || !items.length) return;

                // URL Ï†ïÎ¶¨ (Îí§Î°úÍ∞ÄÍ∏∞ Ïãú Ïû¨import Î∞©ÏßÄ)
                history.replaceState(null, '', location.pathname);

                // import Îç∞Ïù¥ÌÑ∞Î•º stateÏóê ÏûÑÏãú Ï†ÄÏû•
                state.importData = items.map(i => ({
                    name: i.n, code: i.c, quantity: i.q,
                    buyPrice: i.b, targetPrice: i.t || 0,
                    sector: i.s, memo: i.m || '',
                    price: 0, change: 0, changeRate: 0,
                    addedAt: new Date().toISOString(),
                    lastUpdated: null
                }));
                state.showImport = true;
            } catch(e) {
                console.error('Import decode error:', e);
            }
        }

        function doImport(mode) {
            if (!state.importData) return;
            if (mode === 'replace') {
                state.stocks = state.importData;
                showToast(`${state.stocks.length}Í∞ú Ï¢ÖÎ™© Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å`);
            }
            state.importData = null;
            state.showImport = false;
            saveStocks();
            render();
            // Í∞ÄÏ†∏Ïò® ÌõÑ ÏãúÏÑ∏ Í∞±Ïã†
            setTimeout(refreshAll, 500);
        }

        function cancelImport() {
            state.importData = null;
            state.showImport = false;
            render();
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
        loadStocks();
        checkImportUrl();
        render();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }
    </script>
</body>
</html>
